#pragma once

#include "tokenization/tokenization.h"
#include "helpers/arena.h"

// Forward declarations for pointer references
typedef struct NodeExpr NodeExpr;
typedef struct NodeBinExpr NodeBinExpr;
typedef struct NodeBinExprMulti NodeBinExprMulti;
typedef struct NodeBinExprAdd NodeBinExprAdd;
typedef struct NodeStmt NodeStmt;
typedef struct NodeStmtList NodeStmtList;
typedef struct NodeTerm NodeTerm;

// ─── Enums ─────────────────────────────────────────────
typedef enum {
    BIN_INVALID,
    BIN_MULTI,
    BIN_ADD
} NodeBinExprType;

typedef enum {
    TERM_INT_LIT,
    TERM_IDENT
} NodeTermType;

typedef enum {
    EXPR_TERM,
    EXPR_BIN
} NodeExprType;

typedef enum {
    STMT_INVALID,
    STMT_EXIT,
    STMT_LET
} NodeStmtType;

// ─── Expression Nodes ──────────────────────────────────
typedef struct {
    Token int_lit;
} NodeTermIntLit;

typedef struct {
    Token ident;
} NodeTermIdent;

struct NodeBinExpr {
    NodeBinExprType type;
    union {
        NodeBinExprMulti *multi;
        NodeBinExprAdd *add;
    } data;
};

struct NodeTerm {
    NodeTermType type;
    union {
        NodeTermIntLit *int_lit;
        NodeTermIdent *ident;
    } data;
};

struct NodeExpr {
    NodeExprType type;
    union {
        NodeBinExpr *bin;
        NodeTerm *term;
    } data;
};

struct NodeBinExprMulti {
    NodeExpr *lhs;
    NodeExpr *rhs;
};

struct NodeBinExprAdd {
    NodeExpr *lhs;
    NodeExpr *rhs;
};

// ─── Statement Nodes ───────────────────────────────────
typedef struct {
    NodeExpr *expr;
} NodeStmtExit;

typedef struct {
    Token ident;
    NodeExpr *expr;
} NodeStmtLet;

struct NodeStmt {
    NodeStmtType type;
    union {
        NodeStmtExit *exit;
        NodeStmtLet *let;
    } data;
};

// ─── Statement List ────────────────────────────────────
struct NodeStmtList {
    NodeStmt *stmt;
    NodeStmtList *next;
};

typedef struct {
    NodeStmtList *head;
    NodeStmtList *tail;
    size_t size;
} NodeStmtListBuilder;

// ─── Program Node ──────────────────────────────────────
typedef struct {
    NodeStmtList *stmts;
} NodeProg;

// ─── Parser ────────────────────────────────────────────
typedef struct {
    const Token *tokens;
    size_t size;
    size_t pos;
    Arena *arena;
} Parser;

// ─── Function Declarations ─────────────────────────────
void parser_init(Parser *p, const TokenArray *arr);
NodeProg parse_prog(Parser *p);
void parser_free(Parser *p);
